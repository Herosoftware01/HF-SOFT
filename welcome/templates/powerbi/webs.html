{% extends 'mains.html' %}
{% load static %}
{% block content %}

<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />

<style>
  #myGrid {
    height: 700px;
    width: 100%;
  }
</style>

<div>
  <h1>Fabric Data Table</h1>
  <input type="text" id="globalFilter" placeholder="Search all columns..." />
  <div id="rowCount"></div>
  <div id="myGrid" class="ag-theme-alpine"></div>
</div>

<!-- AG Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let existingDataMap = new Map();

  const columnDefs = [
    { headerName: 'buyerid', field: 'buyerid' },
    { headerName: 'buyername', field: 'buyername' },
    { headerName: 'orderno', field: 'orderno' },
    { headerName: 'date', field: 'date' },
    { headerName: 'guid', field: 'guid' },
    { headerName: 'refresh', field: 'refresh' },
  ];

  const gridOptions = {
    columnDefs,
    defaultColDef: {
      sortable: true,
      filter: true,
      floatingFilter: true,
      flex: 1,
      minWidth: 120,
      resizable: true,
    },
    rowSelection: 'multiple',
    animateRows: true,
    getRowNodeId: data => data.buyerid,  // Unique ID for tracking rows
    rowData: [],
  };

  const gridDiv = document.querySelector('#myGrid');
  new agGrid.Grid(gridDiv, gridOptions);

  // Function to fetch and update changed rows
  async function fetchData() {
    try {
      const response = await fetch('https://app.herofashion.com/web_socket/');
      const newData = await response.json();

      const updates = [];
      const inserts = [];

      newData.forEach(row => {
        const existing = existingDataMap.get(row.buyerid);
        const rowString = JSON.stringify(row);

        if (!existing) {
          inserts.push(row);
        } else {
          const existingString = JSON.stringify(existing);
          if (rowString !== existingString) {
            updates.push(row);
          }
        }

        // Update map
        existingDataMap.set(row.buyerid, row);
      });

      // Apply changes
      if (inserts.length > 0 || updates.length > 0) {
        gridOptions.api.applyTransaction({
          add: inserts,
          update: updates,
        });
        document.getElementById('rowCount').innerText = `Total Rows: ${existingDataMap.size}`;
      }
    } catch (error) {
      console.error('Error fetching buyers:', error);
    }
  }

  // Global filter
  document.querySelector('#globalFilter').addEventListener('input', e => {
    gridOptions.api.setQuickFilter(e.target.value);
  });

  fetchData(); // Initial
  setInterval(fetchData, 2000); // Every 2 sec
});
</script>

{% endblock %}
