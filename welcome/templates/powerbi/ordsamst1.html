{% extends 'mains.html' %}
{% load static %}
{% block content %}

  <!-- AG Grid CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css"
  />

  <style>
     .ag-theme-alpine .ag-cell[col-id="img_fpath"] {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      padding: 0 !important;
    }
    /* Row selected */
    .ag-row-selected .ag-cell {
      background-color: #bfdbfe !important; /* Tailwind blue-200 */
    }

    /* Cell focused (selected cell) */
    .ag-cell-focus {
      outline: none !important; /* remove default focus ring */
      background-color: #fbbf24 !important; /* Tailwind yellow-400 */
      color: black !important;
      font-weight: bold;
    }

    /* Highlight only matched text inside cell */
    .search-highlight {
      background-color: #facc15; /* Tailwind yellow-400 */
      color: black;
      font-weight: bold;
      padding: 0 2px;
      border-radius: 2px;
    }

    #myGrid {
      height: 700px;
      width: auto;
      max-width: 100vw; /* don't overflow viewport */
      box-sizing: border-box;
      overflow-x: auto; /* allow horizontal scroll on small screens */
    }

    /* Optional: hide horizontal scrollbar nicely */
    #myGrid::-webkit-scrollbar {
      height: 8px;
    }
    #myGrid::-webkit-scrollbar-thumb {
      background: #cbd5e1; /* Tailwind slate-300 */
      border-radius: 4px;
    }
  </style>

<div class="bg-gray-100 p-6 container mx-auto justify-center">

  <h1 class="text-2xl font-semibold mb-4 text-end">Fabric Data Table</h1>

  <!-- Global filter input -->
  <input
    type="text"
    id="globalFilter"
    placeholder="Search all columns..."
    class="mb-4 p-2 border border-gray-300 rounded w-full max-w-md"
  />

  <div
    id="myGrid"
    class="ag-theme-alpine shadow-lg rounded-lg"
  ></div>

  <!-- AG Grid JS -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const gridDiv = document.querySelector('#myGrid');

      let currentGlobalFilter = '';
      let currentColumnFilters = {};

      function highlightRenderer(params) {
        if (!params.value) return '';

        const cellValue = params.value.toString();
        const filterTexts = [];

        if (currentGlobalFilter) filterTexts.push(currentGlobalFilter);
        if (currentColumnFilters[params.colDef.field]) {
          filterTexts.push(currentColumnFilters[params.colDef.field]);
        }
        if (filterTexts.length === 0) {
          return cellValue;
        }

        const escapedFilters = filterTexts.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        const regex = new RegExp(escapedFilters.join('|'), 'gi');

        let result = '';
        let lastIndex = 0;
        let match;

        while ((match = regex.exec(cellValue)) !== null) {
          const index = match.index;
          result += cellValue.substring(lastIndex, index);
          result += `<span class="search-highlight">${cellValue.substr(index, match[0].length)}</span>`;
          lastIndex = index + match[0].length;
        }
        result += cellValue.substring(lastIndex);
        return result;
      }

      // This function creates the <img> tag for the image column
      function imageCellRenderer(params) {
        if (!params.value) return '';
        return `<img src="${params.value}" alt="image" style="width: 50px; height: 60px; object-fit: contain;" />`;
      }

      // *** CORRECTION: Added the 'image' column definition ***
      const columnDefs = [
        {
          headerName: 'Image',
          field: 'image',
          cellRenderer: imageCellRenderer, // Use the renderer function
          width: 80,
          minWidth: 80,
          flex: 0,
          filter: false, // Usually you don't filter or sort by image
          floatingFilter: false,
          sortable: false,
        },
        {
          headerName: 'jobno',
          field: 'jobno',
          filter: 'agTextColumnFilter',
          checkboxSelection: true,
          maxWidth: 120, // Increased width slightly for better readability
          flex: 0,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'colour',
          field: 'colour',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          flex: 1,
          minWidth: 150,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'buyer',
          field: 'buyer',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          flex: 1,
          minWidth: 150,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'sampletype',
          field: 'sampletype',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          flex: 1,
          minWidth: 150,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'send_dt',
          field: 'send_dt',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          flex: 1,
          minWidth: 150,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'date',
          field: 'date',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          maxWidth: 120, // Increased width
          flex: 0,
          cellRenderer: highlightRenderer
        },
        {
          headerName: 'status',
          field: 'status',
          filter: 'agTextColumnFilter',
          floatingFilter: true,
          flex: 1,
          minWidth: 150,
          cellRenderer: highlightRenderer
        }
      ];

      const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
          sortable: true,
          filter: true,
          floatingFilter: true,
          flex: 1,
          minWidth: 120,
          resizable: true,
          editable: false,
        },
        rowSelection: 'multiple',
        suppressRowClickSelection: true,
        enableCellTextSelection: true,
        animateRows: true,
        rowData: null,
        suppressCellFocus: false,
      };

      new agGrid.Grid(gridDiv, gridOptions);

      try {
        // Ensure this URL is correct and accessible from the browser
        const response = await fetch('http://app.herofashion.com/Ordsampst/');
        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        const data = await response.json();
        gridOptions.api.setRowData(data);
        gridOptions.api.sizeColumnsToFit();
        updateColumnVisibility();
      } catch (error) {
        console.error('Failed to fetch data:', error);
        // Optionally, display an error message to the user in the grid
        gridOptions.api.showNoRowsOverlay(); 
      }

      // Filter changed listener for highlighting text
      gridOptions.api.addEventListener('filterChanged', () => {
        currentColumnFilters = {};
        const filterModel = gridOptions.api.getFilterModel();
        for (const colId in filterModel) {
          if (!filterModel[colId]) continue;
          if (filterModel[colId].filter != null) {
            currentColumnFilters[colId] = filterModel[colId].filter.toString().toLowerCase();
          } else if (
            filterModel[colId].filterType === 'number' &&
            filterModel[colId].type === 'equals' &&
            filterModel[colId].filter !== undefined
          ) {
            currentColumnFilters[colId] = filterModel[colId].filter.toString().toLowerCase();
          }
        }
        gridOptions.api.refreshCells({ force: true });
      });

      // Global filter input listener
      const globalFilterInput = document.querySelector('#globalFilter');
      globalFilterInput.addEventListener('input', function (event) {
        currentGlobalFilter = event.target.value.toLowerCase();
        gridOptions.api.setQuickFilter(currentGlobalFilter);
      });

      // Responsive: auto resize columns on window resize
      window.addEventListener('resize', () => {
        if (gridOptions.api) {
          gridOptions.api.sizeColumnsToFit();
          updateColumnVisibility();
        }
      });

      // Responsive: hide some columns on small screens
      function updateColumnVisibility() {
        if (!gridOptions.columnApi) return;
        const isSmallScreen = window.innerWidth < 640; // Tailwind 'sm' breakpoint
        // Example: You can hide columns here if needed
        // gridOptions.columnApi.setColumnVisible('send_dt', !isSmallScreen);
      }
    });
  </script>
</div>
{% endblock %}