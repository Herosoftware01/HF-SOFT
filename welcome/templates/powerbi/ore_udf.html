{% extends 'mains.html' %}
{% load static %}
{% block content %}

<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />

<style>
  .ag-cell-focus {
    outline: none !important;
    background-color: #fbbf24 !important;
    color: black !important;
    font-weight: bold;
  }
  .search-highlight {
    background-color: #facc15;
    color: black;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 2px;
  }
  #myGrid {
    height: 700px;
    width: auto;
    max-width: 100vw;
    box-sizing: border-box;
    overflow-x: auto;
  }
</style>

<div class="bg-gray-100 p-6 container mx-auto">
  <h1 class="text-2xl font-semibold mb-4 text-end">T Buyer Table</h1>

  <input type="text" id="globalFilter" placeholder="Search all columns..." class="mb-4 p-2 border border-gray-300 rounded w-full max-w-md" />
  <div id="rowCount" class="py-2 text-gray-700 font-semibold text-end"></div>

<div class="overflow-auto w-full max-w-full">
    <div id="myGrid" class="ag-theme-alpine shadow-lg rounded-lg" style="min-width: 1200px;"></div>
    </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-lg">
      <h2 class="text-xl mb-4">Edit Record</h2>
      <form id="editForm">
        <!-- Hidden PK field -->
        <input type="hidden" id="edit_id" name="id" />

        <div class="mb-2">
          <label>Order No:</label>
          <input type="text" id="edit_orderno_field" name="orderno" class="w-full border px-2 py-1" />
        </div>

        <div class="mb-2">
          <label>StyleDesc:</label>
          <input type="text" id="edit_styledesc" name="styledesc" class="w-full border px-2 py-1" />
        </div>

        <div class="mb-2">
          <label>ItemID:</label>
          <input type="number" id="edit_itemid" name="itemid" class="w-full border px-2 py-1" />
        </div>

        <div class="mb-4">
          <label>Value:</label>
          <input type="text" id="edit_value" name="value" class="w-full border px-2 py-1" />
        </div>

        <div class="text-right">
          <button type="button" class="mr-2 text-gray-700" onclick="closeModal()">Cancel</button>
          <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AG Grid JS -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const existingDataMap = new Map();
      const gridDiv = document.querySelector('#myGrid');

      const highlightMatch = (value, filterText) => {
        if (!filterText) return value;
        const regex = new RegExp(`(${filterText})`, 'gi');
        return String(value).replace(regex, '<span class="search-highlight">$1</span>');
      };

      const createRenderer = (field) => (params) => {
        const globalText = document.getElementById('globalFilter').value.toLowerCase();
        const colFilterModel = params.api.getFilterModel()[field];
        let matchText = colFilterModel?.filter?.toLowerCase() || globalText;
        return matchText ? highlightMatch(params.value, matchText) : params.value;
      };

      const columnDefs = [
        { headerName: 'ID', field: 'id', cellRenderer: createRenderer('id'), filter: 'agTextColumnFilter', floatingFilter: true },
        { headerName: 'Order No', field: 'orderno', cellRenderer: createRenderer('orderno'), filter: 'agTextColumnFilter', floatingFilter: true },
        { headerName: 'StyleDesc', field: 'styledesc', cellRenderer: createRenderer('styledesc'), filter: 'agTextColumnFilter', floatingFilter: true },
        { headerName: 'ItemID', field: 'itemid', cellRenderer: createRenderer('itemid'), filter: 'agTextColumnFilter', floatingFilter: true },
        { headerName: 'Value', field: 'value', cellRenderer: createRenderer('value'), filter: 'agTextColumnFilter', floatingFilter: true },
        // {
        //   headerName: 'Actions',
        //   field: 'actions',
        //   minWidth: 150,
        //   cellRenderer: params => `
        //     <button class="edit-btn text-blue-500 mr-2" data-id="${params.data.id}">Edit</button>
        //     <button class="delete-btn text-red-500" data-id="${params.data.id}">Delete</button>
        //   `
        // }
        {
          headerName: 'Actions',
          field: 'actions',
          minWidth: 150,
          cellRenderer: params => `
            <button class="edit-btn text-blue-500 mr-2" data-id="${params.data.id}">Edit</button>
          `
        }
      ];

      const gridOptions = {
        columnDefs,
        defaultColDef: {
          sortable: true,
          filter: true,
          floatingFilter: true,
          flex: 1,
          minWidth: 120,
          resizable: true,
        },
        rowSelection: 'multiple',
        animateRows: true,
        getRowId: params => params.data.id,
        rowData: [],
        onFilterChanged: () => {
          gridOptions.api.refreshCells({ force: true });
        },
      };

      new agGrid.Grid(gridDiv, gridOptions);

      async function fetchData() {
        try {
          const response = await fetch('/ore_udf1/');
          const newData = await response.json();

          const inserts = [];
          const updates = [];

          for (const row of newData) {
            const id = row.id;
            const existingRowJSON = existingDataMap.get(id);
            const newRowJSON = JSON.stringify(row);
            const existingNode = gridOptions.api.getRowNode(id);

            if (!existingRowJSON) {
              if (!existingNode) {
                inserts.push(row);
              } else {
                updates.push(row);
              }
            } else if (existingRowJSON !== newRowJSON) {
              if (existingNode) {
                updates.push(row);
              } else {
                inserts.push(row);
              }
            }
            existingDataMap.set(id, newRowJSON);
          }

          if (inserts.length || updates.length) {
            gridOptions.api.applyTransaction({ add: inserts, update: updates });
            document.getElementById('rowCount').textContent = `Total Rows: ${existingDataMap.size}`;
            gridOptions.api.refreshCells({ force: true });
          }
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      fetchData();
      setInterval(fetchData, 5000);

      document.getElementById('globalFilter').addEventListener('input', () => {
        gridOptions.api.setQuickFilter(document.getElementById('globalFilter').value);
      });

      gridDiv.addEventListener('click', function(e) {
        const target = e.target;
        const id = target.getAttribute('data-id');
        const rowNode = gridOptions.api.getRowNode(id);
        const rowData = rowNode ? rowNode.data : null;

        if (target.classList.contains('edit-btn') && rowData) {
          document.getElementById('edit_id').value = rowData.id;
          document.getElementById('edit_orderno_field').value = rowData.orderno;
          document.getElementById('edit_styledesc').value = rowData.styledesc;
          document.getElementById('edit_itemid').value = rowData.itemid;
          document.getElementById('edit_value').value = rowData.value;
          document.getElementById('editModal').classList.remove('hidden');
        }

        if (target.classList.contains('delete-btn') && rowData) {
          if (confirm(`Delete record ${id}?`)) {
            fetch(`/ordudf_delete/${id}/`, {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': getCSRFToken(),
              },
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'deleted') {
                existingDataMap.delete(id);
                gridOptions.api.applyTransaction({ remove: [rowData] });
              }
            })
            .catch(console.error);
          }
        }
      });

      document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const id = formData.get('id');  // primary key for URL

        fetch(`/ordudf_update/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
          },
          body: formData
        })
        .then(res => {
          if (!res.ok) return res.json().then(err => Promise.reject(err));
          return res.json();
        })
        .then(data => {
          if (data.status === 'success') {
            closeModal();
            fetchData();
          } else {
            alert('Update failed: ' + (data.errors ? JSON.stringify(data.errors) : data.message));
          }
        })
        .catch(error => {
          console.error('Update error:', error);
          alert('Error updating record');
        });
      });

      function getCSRFToken() {
        const cookie = document.cookie.match(/csrftoken=([^;]+)/);
        return cookie ? cookie[1] : '';
      }

      

    });
  </script>
  <script>
  // âœ… Global helper function so onclick works
  function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
  }

  document.addEventListener('DOMContentLoaded', () => {
    // All your existing code stays here
    // ...
    document.getElementById('editModal').classList.add('hidden');

    // No need to re-declare closeModal here again
  });
</script>

{% endblock %}
