{% extends 'mains.html' %}
{% load static %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet"/>

<style>
  .search-highlight {
    background-color: #facc15;
    color: black;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 2px;
  }
  #myGrid {
    height: 700px;
    width: 100%;
    max-width: 100vw;
    box-sizing: border-box;
    overflow-x: auto;
  }
  #myGrid::-webkit-scrollbar { height: 8px; }
  #myGrid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  
  /* ADDITIONAL COMPACT STYLING: Reduce cell padding and font size for more compact display */
  .ag-cell {
    padding: 3px 6px;
    line-height: 1.2;
    font-size: 12px;
  }
  .ag-header-cell {
    padding: 3px 6px;
    font-size: 11px;
    font-weight: 600;
  }
  .ag-row {
    border-bottom: 1px solid #e2e8f0;
  }
  
  /* COMPACT FILTER INPUT STYLING */
  .ag-floating-filter-input {
    font-size: 11px;
    padding: 2px 4px;
  }
</style>

<div class="bg-gray-100 p-6 container mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Order Details Table</h1>
  <div class="flex items-center justify-between mb-4">
    <input type="text" id="globalFilter" placeholder="Search all columns..." class="p-2 border border-gray-300 rounded w-full max-w-md"/>
    <span id="rowCount" class="text-gray-700 font-medium ml-4">Total Rows: Loading...</span>
  </div>
  <div class="overflow-x-auto w-full">
      <div id="myGrid" class="ag-theme-alpine shadow-lg rounded-lg min-w-[640px]"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const gridDiv = document.querySelector('#myGrid');
  const rowCountSpan = document.querySelector('#rowCount');
  let currentGlobalFilter = '';
  let currentColumnFilters = {};
  let totalRowCount = 0;
  let gridApi = null; // Store grid API reference

  // Function to correctly update the row count display
  function updateRowCount() {
    if (gridApi) {
      try {
        const displayedRows = gridApi.getDisplayedRowCount();
        if (totalRowCount > 0) {
          if (displayedRows === totalRowCount) {
            rowCountSpan.textContent = `Total Rows: ${totalRowCount}`;
          } else {
            rowCountSpan.textContent = `Total Rows: ${totalRowCount} | Displayed: ${displayedRows}`;
          }
        } else {
          rowCountSpan.textContent = `Total Rows: ${displayedRows}`;
        }
      } catch (error) {
        console.error('Error updating row count:', error);
        rowCountSpan.textContent = `Total Rows: ${totalRowCount}`;
      }
    } else {
      rowCountSpan.textContent = `Total Rows: Loading...`;
    }
  }

  function multiLineRenderer(params) {
    if (params.value == null) return '';
    const valueString = params.value.toString();
    const lines = valueString.split(/\r\n|\n/).filter(line => line.trim() !== '');
    const container = document.createElement('div');
    container.style.whiteSpace = "normal";
    container.style.lineHeight = "1.2";
    container.style.fontSize = "11px";  // COMPACT FONT SIZE
    container.innerHTML = lines.join('<br>');
    return container;
  }

  function highlightRenderer(params) {
    if (!params.value) return '';
    const raw = params.value.toString();
    const joined = raw.split(/\r\n|\n/).filter(Boolean).join(' | ');
    const filterTexts = [];
    if (currentGlobalFilter) filterTexts.push(currentGlobalFilter);
    if (currentColumnFilters[params.colDef.field]) filterTexts.push(currentColumnFilters[params.colDef.field]);
    if (filterTexts.length === 0) return joined;
    const escapedFilters = filterTexts.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const regex = new RegExp(escapedFilters.join('|'), 'gi');
    let result = '', lastIndex = 0, match;
    while ((match = regex.exec(joined)) !== null) {
      const idx = match.index;
      result += joined.substring(lastIndex, idx);
      result += `<span class="search-highlight">${joined.substr(idx, match[0].length)}</span>`;
      lastIndex = idx + match[0].length;
    }
    result += joined.substring(lastIndex);
    return result;
  }

  // COMPACT IMAGE RENDERER: Reduced image size from 150x180 to 120x140
  function imageCellRenderer(params) {
    if (!params.value) return '';
    return `<img src="${params.value}" alt="image" style="width: 120px; height: 140px; object-fit: contain;" onerror="this.style.display='none'" />`;
  }
      
  const columnDefs = [
    // MAJOR WIDTH REDUCTION: Reduced from 60 to 40
    {
      headerName: 'Job No', 
      field: 'jobno_oms', 
      filter: 'agTextColumnFilter', 
      floatingFilter: true, 
      minWidth: 180, 
      maxWidth: 180,  // MAXIMUM WIDTH CONSTRAINT
      cellRenderer: multiLineRenderer
    },
    // MAJOR WIDTH REDUCTION: Reduced from 100 to 60, added shorter header
    {
      headerName: 'z_o_yy_findt_dir_sty_uom_pty Details', 
      field: 'z_o_yy_findt_dir_sty_uom_pty', 
      filter: 'agTextColumnFilter', 
      floatingFilter: true, 
      minWidth: 120, 
      maxWidth: 180,  // MAXIMUM WIDTH CONSTRAINT
      cellRenderer: multiLineRenderer
    },
     {
      headerName: 'Image', 
      field: 'mainimagepath', 
      filter: 'agTextColumnFilter', 
      floatingFilter: true, 
      minWidth: 130, 
      maxWidth: 150,  // MAXIMUM WIDTH CONSTRAINT
      cellRenderer: imageCellRenderer
    },
    // MAJOR WIDTH REDUCTION: Reduced from 80 to 50, added shorter header
    {
      headerName: 'z_o_dd_ord_findt_buy_mer_qty', 
      field: 'z_o_dd_ord_findt_buy_mer_qty', 
      filter: 'agTextColumnFilter', 
      floatingFilter: true, 
      minWidth: 50, 
      maxWidth: 100,  // MAXIMUM WIDTH CONSTRAINT
      cellRenderer: multiLineRenderer
    },
    // REDUCED IMAGE COLUMN: Reduced from 160 to 130 to accommodate smaller image
    // {
    //   headerName: 'Image', 
    //   field: 'mainimagepath', 
    //   filter: 'agTextColumnFilter', 
    //   floatingFilter: true, 
    //   minWidth: 130, 
    //   maxWidth: 150,  // MAXIMUM WIDTH CONSTRAINT
    //   cellRenderer: imageCellRenderer
    // },
  ];

  const gridOptions = {
    columnDefs,
    defaultColDef: {
      sortable: true, 
      filter: true, 
      floatingFilter: true, 
      // MAJOR DEFAULT WIDTH REDUCTION: Reduced from 50 to 35
      minWidth: 35, 
      // ADDED MAXIMUM WIDTH DEFAULT CONSTRAINT
      maxWidth: 200,
      resizable: true, 
      editable: false, 
      wrapText: true, 
      autoHeight: false,  // DISABLE AUTO HEIGHT FOR COMPACTNESS
      // ADD FLEX FOR RESPONSIVE BEHAVIOR
      flex: 1
    },
    rowSelection: 'multiple',
    suppressRowClickSelection: true,
    enableCellTextSelection: true,
    animateRows: true,
    rowData: null,
    suppressCellFocus: false,
    
    // COMPACT ROW HEIGHT: Reduced dynamic calculation for more compact display
    getRowHeight: params => {
      if (!params.data) return 30; // REDUCED BASE HEIGHT from 35 to 30
      try {
        const lineHeight = 16;  // REDUCED from 20 to 16
        const cellPadding = 10;  // REDUCED from 15 to 10

        // 1. Calculate height needed for multi-line text cells
        const field1 = 'z_o_yy_findt_dir_sty_uom_pty';
        const field2 = 'z_o_dd_ord_findt_buy_mer_qty';
        const lines1 = params.data[field1] ? params.data[field1].toString().split(/\r\n|\n/).length : 1;
        const lines2 = params.data[field2] ? params.data[field2].toString().split(/\r\n|\n/).length : 1;
        const maxLines = Math.max(lines1, lines2);
        const textHeight = maxLines * lineHeight + cellPadding;
        
        // 2. Calculate height needed for the image cell (140px image height + padding)
        const imageHeight = 140 + cellPadding;  // REDUCED from 180 to 140

        // 3. Use the maximum of the text height or the image height
        const finalHeight = Math.max(textHeight, imageHeight);

        return Math.max(finalHeight, 30);  // REDUCED minimum from 35 to 30
      } catch (e) {
        console.warn('Row height calc error:', e);
        return 30;  // REDUCED from 35 to 30
      }
    },
    
    // Store API reference and load data when grid is ready
    onGridReady: function(params) {
      console.log('Grid ready');
      gridApi = params.api; // Store the API reference globally
      loadData(); // Start data fetch
    },

    // Update row count when data changes
    onRowDataUpdated: function() {
      console.log('Row data updated');
      updateRowCount();
    },

    // Update row count when filters change
    onFilterChanged: function() {
      console.log('Filter changed');
      updateRowCount(); 
    },

    // Update row count when model is updated
    onModelUpdated: function() {
      console.log('Model updated');
      updateRowCount();
    }
  };

  // Initialize the grid
  new agGrid.Grid(gridDiv, gridOptions);

  // Data fetching function - only called once the grid is ready
  async function loadData() {
    try {
      console.log('Loading data...');
      rowCountSpan.textContent = 'Total Rows: Loading...';
      
      const response = await fetch('https://app.herofashion.com/order_panda');
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      
      const data = await response.json();
      console.log('Raw data received:', data.length, 'rows');
      
      const mappedData = data.map(row => {
        const conOrdValue = row.con_ord_un_buy_mer_sty_qty || '';
        return {
          jobno_oms: row.jobno_oms || '',
          z_o_yy_findt_dir_sty_uom_pty: row.z_o_yy_findt_dir_sty_uom_pty || '',
          z_o_dd_ord_findt_buy_mer_qty: conOrdValue.toString().split('-').join('\n'),
          mainimagepath: row.mainimagepath || ''
        };
      });

      totalRowCount = mappedData.length;
      console.log('Mapped data:', totalRowCount, 'rows');
      
      // Set the data in the grid
      if (gridApi) {
        gridApi.setRowData(mappedData);
        
        // Wait a bit for the grid to process the data
        setTimeout(() => {
          if (gridApi) {
            // USE RESPONSIVE SIZE TO FIT FOR COMPACT LAYOUT
            gridApi.sizeColumnsToFit();
            // Force row height recalculation after setting data
            gridApi.resetRowHeights(); 
            updateRowCount();
          }
        }, 100);
      }
      
    } catch (error) {
      console.error('Failed to fetch data:', error);
      totalRowCount = 0;
      rowCountSpan.textContent = `Total Rows: Error - ${error.message}`;
    }
  }

  // Global filter handler
  document.querySelector('#globalFilter').addEventListener('input', e => {
    if (!gridApi) {
      console.warn('Grid API not ready for global filter');
      return;
    }
    
    currentGlobalFilter = e.target.value.toLowerCase();
    gridApi.setQuickFilter(currentGlobalFilter);
    
    // Refresh cells and update row count
    setTimeout(() => {
      if (gridApi) {
        gridApi.refreshCells({ force: true });
        updateRowCount();
      }
    }, 50);
  });

  // Window resize handler with responsive column fitting
  window.addEventListener('resize', () => {
    if (gridApi) {
      gridApi.sizeColumnsToFit();
    }
  });
});
</script>

{% endblock %}
