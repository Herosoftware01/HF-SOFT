{% extends 'mains.html' %}
{% load static %}
{% block content %}

<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />

<style>
  .ag-theme-alpine .ag-cell[col-id="img_fpath"] {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0 !important;
  }

  .ag-cell-focus {
    outline: none !important;
    background-color: #fbbf24 !important; /* Tailwind yellow-400 */
    color: black !important;
    font-weight: bold;
  }

  .search-highlight {
    background-color: #facc15;
    color: black;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 2px;
  }

  #myGrid {
    height: 700px;
    width: auto;
    max-width: 100vw;
    box-sizing: border-box;
    overflow-x: auto;
  }

  #myGrid::-webkit-scrollbar {
    height: 8px;
  }

  #myGrid::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
</style>

<div class="bg-gray-100 p-6 container mx-auto justify-center">
  <h1 class="text-2xl font-semibold mb-4 text-end">Order Table</h1>

  <!-- Global Search Input -->
  <input
    type="text"
    id="globalFilter"
    placeholder="Search all columns..."
    class="mb-4 p-2 border border-gray-300 rounded w-full max-w-md"
  />

  <!-- Row Count -->
  <div id="rowCount" class="py-2 text-gray-700 font-semibold text-end"></div>

  <!-- AG Grid Container -->
  <div class="overflow-auto w-full max-w-full">
    <div id="myGrid" class="ag-theme-alpine shadow-lg rounded-lg" style="min-width: 1000px;"></div>
  </div>
</div>

<!-- AG Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#myGrid');
    const existingDataMap = new Map();

    // Highlight matching text
    const highlightMatch = (value, filterText) => {
      if (!filterText || !value) return value;
      const regex = new RegExp(`(${filterText})`, 'gi');
      return String(value).replace(regex, '<span class="search-highlight">$1</span>');
    };

    // Cell renderer for highlighting
    const createRenderer = (field) => {
      return (params) => {
        const globalText = document.getElementById('globalFilter')?.value?.toLowerCase() || '';
        const colFilterModel = params.api.getFilterModel()[field];
        let matchText = '';

        if (colFilterModel?.filter) {
          matchText = colFilterModel.filter.toLowerCase();
        } else if (globalText) {
          matchText = globalText;
        }

        return matchText ? highlightMatch(params.value, matchText) : params.value;
      };
    };

    // Image renderer
    const imageCellRenderer = (params) => {
      if (!params.value) return '';
      return `<img src="${params.value}" alt="Image" style="width: 60px; height: 60px; object-fit: contain;" onerror="this.style.display='none'" />`;
    };

    // Define columns
    const columnDefs = [
      { headerName: 'Job No', field: 'jobno_oms', cellRenderer: createRenderer('jobno_oms'), filter: 'agTextColumnFilter', floatingFilter: true },
      { headerName: 'Final Delivery Date', field: 'final_delivery_date', cellRenderer: createRenderer('final_delivery_date'), filter: 'agTextColumnFilter', floatingFilter: true },
      { headerName: 'PO Date', field: 'podate', cellRenderer: createRenderer('podate'), filter: 'agTextColumnFilter', floatingFilter: true },
      { headerName: 'GUID', field: 'guid', cellRenderer: createRenderer('guid'), filter: 'agTextColumnFilter', floatingFilter: true },
      { headerName: 'Image', field: 'mainimagepath', cellRenderer: imageCellRenderer, filter: false },
      { headerName: 'Reference', field: 'reference', cellRenderer: createRenderer('reference'), filter: 'agTextColumnFilter', floatingFilter: true },
    ];

    const gridOptions = {
      columnDefs,
      defaultColDef: {
        sortable: true,
        filter: true,
        floatingFilter: true,
        flex: 1,
        minWidth: 120,
        resizable: true,
      },
      rowSelection: 'multiple',
      animateRows: true,
      // getRowId: params => params.data.buyerid,
      getRowId: params => params.data.jobno_oms,

      rowData: [],
      onFilterChanged: () => {
        gridOptions.api.refreshCells({ force: true });
      },
    };

    new agGrid.Grid(gridDiv, gridOptions);

    // Fetch and update data
    async function fetchData() {
      try {
        const response = await fetch('/order_panda/');
        const newData = await response.json();

        const inserts = [];
        const updates = [];

        for (const row of newData) {
          const oldRow = existingDataMap.get(row.jobno_oms);
          const newString = JSON.stringify(row);

          if (!oldRow) {
            inserts.push(row);
          } else if (JSON.stringify(oldRow) !== newString) {
            updates.push(row);
          }

          existingDataMap.set(row.jobno_oms, row);
        }

        if (inserts.length || updates.length) {
          gridOptions.api.applyTransaction({ add: inserts, update: updates });
          document.getElementById('rowCount').textContent = `Total Rows: ${existingDataMap.size}`;
          gridOptions.api.refreshCells({ force: true });
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    // Global filter input
    document.querySelector('#globalFilter').addEventListener('input', e => {
      gridOptions.api.setQuickFilter(e.target.value);
      gridOptions.api.refreshCells({ force: true });
    });

    fetchData();
    setInterval(fetchData, 2000); // Polling every 2 seconds
  });
</script>

{% endblock %}
