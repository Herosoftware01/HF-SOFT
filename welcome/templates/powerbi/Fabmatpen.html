{% extends 'mains.html' %}
{% load static %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet"/>

<style>
  .search-highlight {
    background-color: #facc15;
    color: black;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 2px;
  }
  #myGrid {
    height: 700px;
    width: 100%;
    max-width: 100vw;
    box-sizing: border-box;
    overflow-x: auto;
  }
  #myGrid::-webkit-scrollbar { height: 8px; }
  #myGrid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  .ag-cell {
    /* *** CHANGE HERE: Removed 'white-space: normal !important;' to allow single-line text *** */
    padding: 5px 10px;
    line-height: 1.4;
  }
  .ag-row {
    border-bottom: 1px solid #e2e8f0;
  }
</style>

<div class="bg-gray-100 p-6 container mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Order Details Table</h1>
  <input type="text" id="globalFilter" placeholder="Search all columns..." class="mb-4 p-2 border border-gray-300 rounded w-full max-w-md"/>
  <div id="myGrid" class="ag-theme-alpine shadow-lg rounded-lg"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.2/dist/ag-grid-community.min.noStyle.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const gridDiv = document.querySelector('#myGrid');
  let currentGlobalFilter = '';
  let currentColumnFilters = {};

  function multiLineRenderer(params) {
    if (params.value == null) return '';
    const valueString = params.value.toString();
    const lines = valueString.split(/\r\n|\n/).filter(line => line.trim() !== '');
    const container = document.createElement('div');
    container.style.whiteSpace = "normal";
    container.style.lineHeight = "1.4";
    container.innerHTML = lines.join('<br>');
    return container;
  }

  function highlightRenderer(params) {
    if (!params.value) return '';
    const raw = params.value.toString();
    const joined = raw.split(/\r\n|\n/).filter(Boolean).join(' | ');
    const filterTexts = [];
    if (currentGlobalFilter) filterTexts.push(currentGlobalFilter);
    if (currentColumnFilters[params.colDef.field]) filterTexts.push(currentColumnFilters[params.colDef.field]);
    if (filterTexts.length === 0) return joined;
    const escapedFilters = filterTexts.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const regex = new RegExp(escapedFilters.join('|'), 'gi');
    let result = '', lastIndex = 0, match;
    while ((match = regex.exec(joined)) !== null) {
      const idx = match.index;
      result += joined.substring(lastIndex, idx);
      result += `<span class="search-highlight">${joined.substr(idx, match[0].length)}</span>`;
      lastIndex = idx + match[0].length;
    }
    result += joined.substring(lastIndex);
    return result;
  }
  function imageCellRenderer(params) {
        if (!params.value) return '';
        return `<img src="${params.value}" alt="image" style="width: 50px; height: 60px; object-fit: contain;" />`;
      }
  const columnDefs = [
    // *** CHANGE HERE: Modified the 'No' column definition ***
    {headerName: 'orderno', field: 'orderno', filter: 'agNumberColumnFilter', checkboxSelection: true, minWidth: 120, flex: 0, wrapText: false, cellRenderer: highlightRenderer},
    {headerName: 'date', field: 'date', filter: 'agTextColumnFilter', floatingFilter: true, flex: 2, minWidth: 220, cellRenderer: multiLineRenderer},
    {headerName: 'status', field: 'status', filter: 'agTextColumnFilter', floatingFilter: true, flex: 1, minWidth: 150, cellRenderer: multiLineRenderer},
    {headerName: 'days', field: 'days', filter: 'agTextColumnFilter', floatingFilter: true, flex: 1, minWidth: 160, cellRenderer: highlightRenderer},
    // {headerName: 'mainimagepath', field: 'mainimagepath', filter: 'agTextColumnFilter', floatingFilter: true, flex: 1, minWidth: 160, cellRenderer: imageCellRenderer},
    // {headerName: 'Merch', field: 'merch', filter: 'agDateColumnFilter', floatingFilter: true, flex: 1, minWidth: 160, valueFormatter: params => params.value ? new Date(params.value).toLocaleString() : '', cellRenderer: highlightRenderer},
    // {headerName: 'Quantity', field: 'quantity', filter: 'agTextColumnFilter', floatingFilter: true, maxWidth: 190, flex: 0, cellRenderer: highlightRenderer}
  ];

  const gridOptions = {
    columnDefs,
    defaultColDef: {sortable: true, filter: true, floatingFilter: true, flex: 1, minWidth: 120, resizable: true, editable: false, wrapText: true, autoHeight: true},
    rowSelection: 'multiple',
    suppressRowClickSelection: true,
    enableCellTextSelection: true,
    animateRows: true,
    rowData: null,
    suppressCellFocus: false,
    getRowHeight: params => {
      if (!params.data) return 35;
      const field1 = 'con_findt_ordno_dir_un_buy_uom_qty_mer';
      const field2 = 'con_ord_un_buy_mer_sty_qty';
      const lines1 = params.data[field1] ? params.data[field1].toString().split(/\r\n|\n/).length : 1;
      const lines2 = params.data[field2] ? params.data[field2].toString().split(/\r\n|\n/).length : 1;
      const maxLines = Math.max(lines1, lines2);
      return maxLines * 20 + 15;
    }
  };
  
  new agGrid.Grid(gridDiv, gridOptions);

  try {
    const response = await fetch('https://app.herofashion.com/ordmatpen');
    if (!response.ok) throw new Error('Network response was not ok');
    const data = await response.json();
    
    const mappedData = data.map(row => {
      const conOrdValue = row.con_ord_un_buy_mer_sty_qty || '';
      return {
        orderno: row.orderno,
        date: row.date,
        // con_ord_un_buy_mer_sty_qty: conOrdValue.toString().split('-').join('\n'),
        status: row.status,
        days: row.days,
        // quantity: row.quantity,
        // mainimagepath: row.mainimagepath
      };
    });

    gridOptions.api.setRowData(mappedData);
    gridOptions.api.sizeColumnsToFit();
  } catch (error) {
    console.error('Failed to fetch data:', error);
  }

  gridOptions.api.addEventListener('filterChanged', () => {
    currentColumnFilters = {};
    const filterModel = gridOptions.api.getFilterModel();
    for (const colId in filterModel) {
      if (!filterModel[colId]) continue;
      if (filterModel[colId].filter != null) {
        currentColumnFilters[colId] = filterModel[colId].filter.toString().toLowerCase();
      }
    }
    gridOptions.api.refreshCells({ force: true });
  });

  document.querySelector('#globalFilter').addEventListener('input', e => {
    currentGlobalFilter = e.target.value.toLowerCase();
    gridOptions.api.setQuickFilter(currentGlobalFilter);
    gridOptions.api.refreshCells({ force: true });
  });

  window.addEventListener('resize', () => {
    if (gridOptions.api) gridOptions.api.sizeColumnsToFit();
  });
});
</script>

{% endblock %}