{% extends 'mains.html' %}

{% load static %}

{% block title %}Attendance{% endblock %}

{% block content %}


    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Tailwind Config for Purple Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dashboard-purple': '#7A85C1',
                        'card-blue': '#4F46E5',
                        'card-green': '#10B981',
                        'card-orange': '#F59E0B',
                        'card-red': '#EF4444'
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles for Cell Selection -->
    <style>
        /* Custom CSS */
        .bg-dashboard-purple { background-color: #6366f1; }
        .bg-card-blue { background-color: #3b82f6; }
        .bg-card-green { background-color: #10b981; }
        .bg-card-orange { background-color: #f59e0b; }
        .bg-card-red { background-color: #ef4444; }
        
        .table-cell-selected {
            background-color: #6eadff !important;
            outline: 2px solid #3b82f6;
        }
        
        .cell-navigation-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .cell-navigation-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .table-navigable {
            outline: none;
        }
        
        .table-navigable:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen">
                   <!-- Header -->
    <div class="bg-dashboard-purple shadow-lg">
        <div class="container mx-auto px-4 lg:px-6 py-4">
             <!-- Title and Single Line Filters -->
            <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Title Section -->
                <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
                    <div class="w-8 h-8 lg:w-10 lg:h-10 bg-white rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 lg:w-6 lg:h-6 text-dashboard-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        </div>
                            <h1 class="text-sm sm:text-lg lg:text-2xl font-bold text-white whitespace-nowrap">AGING DASHBOARD</h1>
                        </div>
                        
                        <!-- Single Line Filters with Horizontal Scroll -->
                        <div class="flex-1 overflow-x-auto">
                            <form method="get" class="flex items-center gap-2 sm:gap-3 lg:gap-4 min-w-max justify-end pb-1" id="filterForm">
                                <!-- Bill Type Filter -->
                                <div class="flex flex-col">
                                    <label class="text-white text-[12px] sm:text-xs font-medium mb-1 whitespace-nowrap text-center">Bill Type</label>
                                    <select name="module" class="w-20 sm:w-24 lg:w-24 px-2 sm:px-3 lg:px-4 p-2 rounded-xl border-2 border-black bg-white text-gray-500 font-bold text-[10px] sm:text-xs" onchange="submitForm()">
                                        <option value="">ALL</option>
                                        {% for module_item in module_datas %}
                                            {% if module_item %}
                                                <option value="{{ module_item }}" {% if request.GET.module == module_item %}selected{% endif %}>
                                                    {{ module_item }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Incharge Filter -->
                                <div class="flex flex-col min-w-0">
                                    <label class="text-white text-[10px] sm:text-xs font-medium mb-1 whitespace-nowrap text-center">Incharge</label>
                                    <select name="employees" class="w-16 sm:w-20 lg:w-24 px-2 sm:px-3 lg:px-4 p-2 rounded-xl border-2 border-black bg-white font-bold text-gray-500 text-[10px] sm:text-xs" onchange="submitForm()">
                                        <option value="ALL" {% if request.GET.employees == "ALL" or not request.GET.employees %}selected{% endif %}>ALL</option>
                                        {% for emp in employees %}
                                            <option value="{{ emp.id }}" {% if request.GET.employees == emp.id|stringformat:"s" %}selected{% endif %}>
                                                {{ emp.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- From Date -->
                                <div class="flex flex-col min-w-0">
                                    <label class="text-white text-[10px] sm:text-xs font-medium mb-1 whitespace-nowrap text-center">From</label>
                                    <input type="date" name="from_date" value="{{ request.GET.from_date }}" 
                                        class="w-20 sm:w-24 lg:w-28 px-1 sm:px-2 lg:px-3 p-2 rounded-xl border-2 border-black bg-white text-gray-500 font-bold text-[10px] sm:text-xs" onchange="submitForm()">
                                </div>
                                
                                <!-- To Date -->
                                <div class="flex flex-col min-w-0">
                                    <label class="text-white text-[10px] sm:text-xs font-medium mb-1 whitespace-nowrap text-center">To</label>
                                    <input type="date" name="to_date" value="{{ request.GET.to_date }}" 
                                        class="w-20 sm:w-24 lg:w-28 px-1 sm:px-2 lg:px-3 p-2 rounded-xl border-2 border-black bg-white text-gray-500 font-bold text-[10px] sm:text-xs" onchange="submitForm()">
                                </div>
                                
                                <!-- Min Aging Filter -->
                                <div class="flex flex-col min-w-0">
                                    <label class="text-white text-[10px] sm:text-xs font-medium mb-1 whitespace-nowrap text-center">Min Age</label>
                                    <select name="min_aging" class="w-14 sm:w-16 lg:w-20 px-1 sm:px-2 lg:px-3 p-2 rounded-xl border-2 border-black bg-white font-bold text-gray-500 text-[10px] sm:text-xs" onchange="submitForm()">
                                        <option value="">All</option>
                                        <option value="7" {% if request.GET.min_aging == "7" %}selected{% endif %}>7+</option>
                                        <option value="15" {% if request.GET.min_aging == "15" %}selected{% endif %}>15+</option>
                                        <option value="30" {% if request.GET.min_aging == "30" %}selected{% endif %}>30+</option>
                                        <option value="60" {% if request.GET.min_aging == "60" %}selected{% endif %}>60+</option>
                                        <option value="90" {% if request.GET.min_aging == "90" %}selected{% endif %}>90+</option>
                                    </select>
                                </div>
                                
                                <!-- Clear Button -->
                                <div class="flex flex-col justify-end mt-4">
                                    <button type="button" onclick="clearFilters()" class="px-4 p-2 bg-[#77BEF0] text-white rounded-xl hover:bg-[#5BA8D4] transition-colors text-sm font-medium w-full lg:w-auto">
                                        Clear Filters
                                    </button>
                                </div>
                            </form>
                        </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 lg:px-6 py-6 lg:py-8">
        <!-- KPI Cards - Mobile: 1 column, Desktop: 2 columns with reduced size -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6 lg:mb-8 max-w-2xl mx-auto">
            <!-- Total Bills Card -->
            <div class="bg-white rounded-lg shadow-md p-3 lg:p-4 border-l-4 border-card-blue">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div class="mb-2 lg:mb-0">
                        <p class="text-xs font-medium text-gray-600 mb-1">Total Bills</p>
                        <p class="text-lg lg:text-2xl font-bold text-gray-800" id="totalBillsCount">{{ data_count }}</p>
                        <p class="text-xs text-gray-500 mt-1">Active Records</p>
                    </div>
                    <div class="w-6 h-6 lg:w-8 lg:h-8 bg-card-blue rounded-lg flex items-center justify-center lg:ml-2">
                        <svg class="w-3 h-3 lg:w-4 lg:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Risk Assessment Card with Clickable Filters -->
            <div class="bg-white rounded-lg shadow-md p-3 lg:p-4 border-l-4 border-card-red">
                <div class="flex flex-col space-y-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold text-gray-800 mb-1 ">Risk Assessment</p>
                        </div>
                        <div class="w-6 h-6 lg:w-8 lg:h-8 bg-card-red rounded-lg flex items-center justify-center">
                            <svg class="w-3 h-3 lg:w-4 lg:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Clickable Risk Statistics Filters -->
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-[#BADFDB] p-2 rounded cursor-pointer hover:bg-green-400 transition" onclick="filterRiskData('normal')">
                            <p class="text-lg lg:text-xl font-bold text-green-700" id="normalCount">0</p>
                            <p class="text-xs text-green-600">Normal</p>
                        </div>
                        <div class="bg-[#FFDE63]  p-2 rounded cursor-pointer hover:bg-yellow-400 transition" onclick="filterRiskData('risk')">
                            <p class="text-lg lg:text-xl font-bold text-yellow-700" id="riskCount">0</p>
                            <p class="text-xs text-yellow-600">Risk</p>
                        </div>
                        <div class="bg-[#FF8989]  p-2 rounded cursor-pointer hover:bg-red-400 transition" onclick="filterRiskData('high_risk')">
                            <p class="text-lg lg:text-xl font-bold text-[#F75270]" id="highRiskCount">0</p>
                            <p class="text-xs text-red-600">High Risk</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Mobile: Card Layout, Desktop: Table Layout -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-300">
            <!-- Table/Card Header -->
            <div class="bg-dashboard-purple px-4 lg:px-6 py-4 border-b border-gray-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <h2 class="text-lg lg:text-xl font-semibold text-white">AGEING BETWEEN BR DATE AND BILL DATE</h2>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                        <span class="text-white text-xs lg:text-sm">Report Generated: <span id="currentDate"></span></span>
                        <button onclick="exportToExcel()" class="px-3 lg:px-4 py-2 bg-white text-dashboard-purple rounded-lg hover:bg-gray-100 transition-colors font-medium flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Card View (Hidden on Desktop) -->
            <div class="block lg:hidden max-h-[500px] overflow-y-auto">
                {% for item in datas %}
                <div class="border-b border-gray-200 p-4 hover:bg-gray-50 transition-colors" data-aging="{{ item.calculated_aging|default:0 }}">
                    <div class="space-y-3">
                        <!-- Row 1: Bill Info -->
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-gray-900 text-sm">{{ item.suppliers|default:"-" }}</div>
                                <div class="text-xs text-gray-500">{{ item.billno|default:"-" }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-900">
                                    {% if item.amount %}₹{{ item.amount|floatformat:"2g" }}{% else %}-{% endif %}
                                </div>
                                <div class="text-xs text-gray-500">{{ item.billdate|date:"d/m/Y"|default:"-" }}</div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Details -->
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col space-y-1">
                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full w-fit">
                                    {{ item.module|default:"-" }}
                                </span>
                                <div class="text-xs text-gray-600">{{ item.employees|default:"-" }}</div>
                            </div>
                            <div class="text-center">
                                {% if item.calculated_aging is not None %}
                                    {% if item.calculated_aging <= 2 %}
                                        <span class="px-3 py-1 text-xs font-bold bg-green-100 text-green-800 rounded-full border border-green-200">
                                            {{ item.calculated_aging }} days
                                        </span>
                                    {% elif item.calculated_aging <= 5 %}
                                        <span class="px-3 py-1 text-xs font-bold bg-yellow-100 text-yellow-800 rounded-full border border-yellow-200">
                                            {{ item.calculated_aging }} days
                                        </span>
                                    {% else %}
                                        <span class="px-3 py-1 text-xs font-bold bg-red-100 text-red-800 rounded-full border border-red-200">
                                            {{ item.calculated_aging }} days
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="px-3 py-1 text-xs font-bold bg-gray-100 text-gray-800 rounded-full border border-gray-200">
                                        - days
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Row 3: Date Info -->
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Date: {{ item.edate|date:"d/m/Y"|default:"-" }}</span>
                            <span>SL: {{ item.no }}</span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-gray-500">
                    <svg class="w-12 h-12 text-gray-300 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-lg font-medium text-gray-500">No records found</p>
                    <p class="text-sm text-gray-400">Try adjusting your filters</p>
                </div>
                {% endfor %}
            </div>

            <!-- Desktop Table View with Keyboard Navigation (Hidden on Mobile) -->
            <div class="hidden lg:block overflow-x-auto h-[500px] border-2 border-gray-300">
                <table id="ageingTable" class="w-full text-sm border-collapse border-separate border-spacing-0 border-gray-400 table-navigable" tabindex="0">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr class="border-b border-gray-400">
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">SL NO</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">BILL DATE</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">ENTRY DATE</th>
                            <th class="px-4 py-3 text-center font-semibold text-white bg-dashboard-purple text-white border border-gray-400">AGEING (DAYS)</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">BILL TYPE</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">SUPPLIER</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">INCHARGE</th>
                            <th class="px-4 py-3 text-left font-semibold text-white bg-dashboard-purple text-white border border-gray-400">BILL NO</th>
                            <th class="px-4 py-3 text-right font-semibold text-white bg-dashboard-purple text-white border border-gray-400">BILL AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        {% for item in datas %}
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-300" data-row="{{ forloop.counter0 }}" data-aging="{{ item.calculated_aging|default:0 }}">
                            <td class="px-4 py-3 border border-gray-300" data-col="0">{{ item.no }}</td>
                            <td class="px-4 py-3 border border-gray-300" data-col="6">{{ item.billdate|date:"d/m/Y"|default:"-" }}</td>
                            <td class="px-4 py-3 border border-gray-300" data-col="1">{{ item.edate|date:"d/m/Y"|default:"-" }}</td>
                            <td class="px-4 py-3 text-center border border-gray-300" data-col="8">
                                {% if item.calculated_aging is not None %}
                                    {% if item.calculated_aging <= 2 %}
                                        <span class="px-3 py-1 text-xs font-bold bg-green-100 text-green-800 rounded-full border border-green-200">
                                            {{ item.calculated_aging }}
                                        </span>
                                    {% elif item.calculated_aging <= 5 %}
                                        <span class="px-3 py-1 text-xs font-bold bg-yellow-100 text-yellow-800 rounded-full border border-yellow-200">
                                            {{ item.calculated_aging }}
                                        </span>
                                    {% else %}
                                        <span class="px-3 py-1 text-xs font-bold bg-red-100 text-red-800 rounded-full border border-red-200">
                                            {{ item.calculated_aging }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="px-3 py-1 text-xs font-bold bg-gray-100 text-gray-800 rounded-full border border-gray-200">
                                        
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 border border-gray-300" data-col="2">
                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                    {{ item.module|default:"-" }}
                                </span>
                            </td>
                            <td class="px-4 py-3 font-medium text-gray-900 border border-gray-300" data-col="3">{{ item.suppliers|default:"-" }}</td>
                            <td class="px-4 py-3 border border-gray-300" data-col="4">{{ item.employees|default:"-" }}</td>
                            <td class="px-4 py-3 font-mono text-sm border border-gray-300" data-col="5">{{ item.billno|default:"-" }}</td>
                            <td class="px-4 py-3 text-right font-semibold text-gray-900 border border-gray-300" data-col="7">
                                {% if item.amount %}₹{{ item.amount|floatformat:"2g" }}{% else %}-{% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500 border border-gray-300">
                                <div class="flex flex-col items-center">
                                    <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                                    <p class="text-lg font-medium text-gray-500">No records found</p>
                                    <p class="text-sm text-gray-400">Try adjusting your filters</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

  <script>
        document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById("ageingTable");
        const headers = table.querySelectorAll("thead th");

        // ✅ Only make Bill Type, Supplier, Incharge sortable
        const sortableColumns = [4, 5, 6]; // Index based on your table order

        // Keep track of sort direction for each column
        let sortDirection = {};

        headers.forEach((header, index) => {
            if (sortableColumns.includes(index)) {
                // Add icon next to header text
                const icon = document.createElement("i");
                icon.className = "fa-solid fa-sort ml-2 text-gray-300 sort-icon";
                header.appendChild(icon);

                // Add click event for sorting
                header.classList.add("cursor-pointer", "select-none", "transition");
                header.addEventListener("click", () => sortTable(index, header));
            }
        });

        function sortTable(index, header) {
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const currentDir = sortDirection[index] === "asc" ? "desc" : "asc";
            sortDirection[index] = currentDir;

            // Reset all icons
            headers.forEach((h, i) => {
                const icon = h.querySelector(".sort-icon");
                if (icon) icon.className = "fa-solid fa-sort ml-2 text-gray-300 sort-icon";
            });

            // Update icon for current sort direction
            const icon = header.querySelector(".sort-icon");
            if (currentDir === "asc") {
                icon.className = "fa-solid fa-sort-up ml-2 text-purple-600 sort-icon";
            } else {
                icon.className = "fa-solid fa-sort-down ml-2 text-purple-600 sort-icon";
            }

            // Sort rows based on column text
            rows.sort((a, b) => {
                const valA = a.cells[index].innerText.trim().toLowerCase();
                const valB = b.cells[index].innerText.trim().toLowerCase();

                if (valA < valB) return currentDir === "asc" ? -1 : 1;
                if (valA > valB) return currentDir === "asc" ? 1 : -1;
                return 0;
            });

            // Reattach sorted rows
            tbody.append(...rows);
        }
        });
    </script>


    <script>
    // Table Navigation Variables
    let currentRow = -1;
    let currentCol = -1;
    let maxRows = 0;
    let maxCols = 9;
    let navigationActive = false;

    // Mobile filter toggle function
    function toggleFilters() {
        const filtersContainer = document.getElementById('filtersContainer');
        const filterToggle = document.getElementById('filterToggle');
        
        if (filtersContainer.classList.contains('hidden')) {
            filtersContainer.classList.remove('hidden');
            filtersContainer.classList.add('block');
            filterToggle.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
        } else {
            filtersContainer.classList.add('hidden');
            filtersContainer.classList.remove('block');
            filterToggle.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                </svg>
            `;
        }
    }

    // Submit form function for filters
    function submitForm() {
        document.getElementById('filterForm').submit();
    }

    // Clear filters function
    function clearFilters() {
        const form = document.getElementById('filterForm');
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type === 'date') {
                input.value = '';
            } else {
                input.selectedIndex = 0;
            }
        });
        form.submit();
    }

    // ✅ Updated Risk filtering function (for clickable cards)
    function filterRiskData(type) {
        const tableRows = document.querySelectorAll('#ageingTable tbody tr[data-aging]');
        const mobileCards = document.querySelectorAll('.block.lg\\:hidden > div[data-aging]');
        
        // Remove highlight ring from all
        document.querySelectorAll('.grid > div').forEach(div => div.classList.remove('ring', 'ring-offset-2', 'ring-blue-400'));
        
        // Highlight selected filter
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('ring', 'ring-offset-2', 'ring-blue-400');
        }

        // Apply filtering logic
        tableRows.forEach(row => {
            const aging = parseInt(row.getAttribute('data-aging')) || 0;
            let show = false;
            
            switch(type) {
                case 'normal':
                    show = aging <= 2;
                    break;
                case 'risk':
                    show = aging >= 3 && aging <= 5;
                    break;
                case 'high_risk':
                    show = aging > 5;
                    break;
                default:
                    show = true;
            }
            
            row.style.display = show ? '' : 'none';
        });

        mobileCards.forEach(card => {
            const aging = parseInt(card.getAttribute('data-aging')) || 0;
            let show = false;
            
            switch(type) {
                case 'normal':
                    show = aging <= 2;
                    break;
                case 'risk':
                    show = aging >= 3 && aging <= 5;
                    break;
                case 'high_risk':
                    show = aging > 5;
                    break;
                default:
                    show = true;
            }
            
            card.style.display = show ? '' : 'none';
        });
    }

    // Cell Navigation Functions
    function initializeTableNavigation() {
        const table = document.getElementById('ageingTable');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        
        maxRows = 0;
        rows.forEach(row => {
            if (row.cells && row.cells.length > 1 && !row.cells[0].textContent.includes('No records found')) {
                maxRows++;
            }
        });

        table.addEventListener('keydown', handleTableKeyNavigation);
        table.addEventListener('click', handleTableClick);
        table.addEventListener('focus', handleTableFocus);
        
        rows.forEach((row, rowIndex) => {
            if (row.cells && row.cells.length > 1 && !row.cells[0].textContent.includes('No records found')) {
                Array.from(row.cells).forEach((cell, colIndex) => {
                    cell.addEventListener('click', () => {
                        selectCell(rowIndex, colIndex);
                    });
                });
            }
        });
    }

    function handleTableFocus() {
        showNavigationIndicator();
        if (currentRow === -1 && currentCol === -1 && maxRows > 0) {
            selectCell(0, 0);
        }
    }

    function handleTableClick(e) {
        if (e.target.tagName === 'TD') {
            const row = e.target.parentElement;
            const rowIndex = parseInt(row.getAttribute('data-row'));
            const colIndex = parseInt(e.target.getAttribute('data-col'));
            
            if (!isNaN(rowIndex) && !isNaN(colIndex)) {
                selectCell(rowIndex, colIndex);
            }
        }
    }

    function handleTableKeyNavigation(e) {
        if (!navigationActive && maxRows === 0) return;

        const keyCode = e.keyCode || e.which;
        
        switch(keyCode) {
            case 37: e.preventDefault(); navigateLeft(); break;
            case 38: e.preventDefault(); navigateUp(); break;
            case 39: e.preventDefault(); navigateRight(); break;
            case 40: e.preventDefault(); navigateDown(); break;
            case 13: e.preventDefault();
                if (currentRow === -1 && currentCol === -1) selectCell(0, 0);
                else focusCurrentCell();
                break;
            case 27: e.preventDefault(); clearCellSelection(); break;
            case 9:
                if (!navigationActive) return;
                e.preventDefault();
                e.shiftKey ? navigateLeft() : navigateRight();
                break;
        }
    }

    function selectCell(row, col) {
        if (row < 0 || row >= maxRows || col < 0 || col >= maxCols) return;

        clearCellSelection();

        currentRow = row;
        currentCol = col;
        navigationActive = true;

        const cell = getCellElement(row, col);
        if (cell) {
            cell.classList.add('table-cell-selected');
            scrollToCellIfNeeded(cell);
            showNavigationIndicator();
        }
    }

    function clearCellSelection() {
        const table = document.getElementById('ageingTable');
        if (table) {
            const selectedCells = table.querySelectorAll('.table-cell-selected');
            selectedCells.forEach(cell => cell.classList.remove('table-cell-selected'));
        }
        currentRow = -1;
        currentCol = -1;
        navigationActive = false;
        hideNavigationIndicator();
    }

    function getCellElement(row, col) {
        const table = document.getElementById('ageingTable');
        if (!table) return null;

        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        
        let actualRowIndex = 0;
        for (let i = 0; i < rows.length; i++) {
            const currentRow = rows[i];
            if (currentRow.cells && currentRow.cells.length > 1 && !currentRow.cells[0].textContent.includes('No records found')) {
                if (actualRowIndex === row) {
                    return currentRow.cells[col];
                }
                actualRowIndex++;
            }
        }
        return null;
    }

    function navigateUp() { if (currentRow > 0) selectCell(currentRow - 1, currentCol); }
    function navigateDown() { if (currentRow < maxRows - 1) selectCell(currentRow + 1, currentCol); }
    function navigateLeft() {
        if (currentCol > 0) selectCell(currentRow, currentCol - 1);
        else if (currentRow > 0) selectCell(currentRow - 1, maxCols - 1);
    }
    function navigateRight() {
        if (currentCol < maxCols - 1) selectCell(currentRow, currentCol + 1);
        else if (currentRow < maxRows - 1) selectCell(currentRow + 1, 0);
    }

    function focusCurrentCell() {
        const cell = getCellElement(currentRow, currentCol);
        if (cell) cell.focus();
    }

    function scrollToCellIfNeeded(cell) {
        const tableContainer = cell.closest('.overflow-x-auto');
        if (!tableContainer) return;

        const containerRect = tableContainer.getBoundingClientRect();
        const cellRect = cell.getBoundingClientRect();

        if (cellRect.top < containerRect.top || cellRect.bottom > containerRect.bottom) {
            cell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }

        if (cellRect.left < containerRect.left || cellRect.right > containerRect.right) {
            cell.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function showNavigationIndicator() {
        const indicator = document.getElementById('navigationIndicator');
        if (indicator && window.innerWidth >= 1024) {
            indicator.classList.add('show');
            clearTimeout(window.indicatorTimeout);
            window.indicatorTimeout = setTimeout(() => hideNavigationIndicator(), 3000);
        }
    }

    function hideNavigationIndicator() {
        const indicator = document.getElementById('navigationIndicator');
        if (indicator) {
            indicator.classList.remove('show');
            clearTimeout(window.indicatorTimeout);
        }
    }

    // Format date in Indian format (DD/MM/YYYY)
    function formatIndianDate(date) {
        if (!date) return '';
        
        let day, month, year;
        if (date instanceof Date) {
            day = date.getDate().toString().padStart(2, '0');
            month = (date.getMonth() + 1).toString().padStart(2, '0');
            year = date.getFullYear();
        } else {
            const dateStr = date.toString();
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateStr;
            const parsedDate = new Date(dateStr);
            if (!isNaN(parsedDate.getTime())) {
                day = parsedDate.getDate().toString().padStart(2, '0');
                month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                year = parsedDate.getFullYear();
            } else return dateStr;
        }
        return `${day}/${month}/${year}`;
    }

    function getCurrentIndianDate() {
        const today = new Date();
        return formatIndianDate(today);
    }

    function calculateStats() {
        const table = document.getElementById('ageingTable');
        let validRows = 0;
        let normalCount = 0;
        let riskCount = 0;
        let highRiskCount = 0;
        
        const mobileCards = document.querySelectorAll('.block.lg\\:hidden > div[data-aging]');
        
        if (window.innerWidth < 1024) {
            mobileCards.forEach(card => {
                if (card.querySelector('.font-semibold.text-gray-900.text-sm')) {
                    validRows++;
                    const aging = parseInt(card.getAttribute('data-aging')) || 0;
                    if (aging <= 2) normalCount++;
                    else if (aging <= 5) riskCount++;
                    else highRiskCount++;
                }
            });
        } else if (table) {
            const rows = table.querySelectorAll('tbody tr[data-aging]');
            rows.forEach(row => {
                if (row.cells && row.cells.length > 8 && !row.cells[0].textContent.includes('No records found')) {
                    validRows++;
                    const aging = parseInt(row.getAttribute('data-aging')) || 0;
                    if (aging <= 2) normalCount++;
                    else if (aging <= 5) riskCount++;
                    else highRiskCount++;
                }
            });
        }

        document.getElementById('totalBillsCount').textContent = validRows;
        document.getElementById('normalCount').textContent = normalCount;
        document.getElementById('riskCount').textContent = riskCount;
        document.getElementById('highRiskCount').textContent = highRiskCount;
    }

    // Export to Excel function
    function exportToExcel() {
        try {
            const table = document.getElementById('ageingTable');
            const tableClone = table.cloneNode(true);
            const selectedCells = tableClone.querySelectorAll('.table-cell-selected');
            selectedCells.forEach(cell => cell.classList.remove('table-cell-selected'));
            
            const rows = tableClone.querySelectorAll('tr');
            rows.forEach((row) => {
                const cells = row.cells;
                if (cells.length > 0) {
                    if (cells[1]) cells[1].textContent = formatIndianDate(cells[1].textContent.trim());
                    if (cells[6]) cells[6].textContent = formatIndianDate(cells[6].textContent.trim());
                }
            });

            const wb = XLSX.utils.table_to_book(tableClone, { sheet: "Aging Report", raw: false });
            const ws = wb.Sheets["Aging Report"];
            ws['!cols'] = [
                {wch: 8}, {wch: 12}, {wch: 15}, {wch: 25}, {wch: 20},
                {wch: 15}, {wch: 12}, {wch: 18}, {wch: 12}
            ];

            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const amountCell = XLSX.utils.encode_cell({r: row, c: 7});
                if (ws[amountCell] && ws[amountCell].t === 's') {
                    const value = ws[amountCell].v.replace(/[₹,]/g, '').trim();
                    if (!isNaN(value) && value !== '' && value !== '-') {
                        ws[amountCell].v = parseFloat(value);
                        ws[amountCell].t = 'n';
                        ws[amountCell].z = '₹#,##0';
                    }
                }
            }

            XLSX.utils.sheet_add_aoa(ws, [['AGING DASHBOARD REPORT']], {origin: 'A1'});
            XLSX.utils.sheet_add_aoa(ws, [['Generated on: ' + getCurrentIndianDate()]], {origin: 'A2'});
            XLSX.utils.sheet_add_aoa(ws, [['']], {origin: 'A3'});

            const newRange = XLSX.utils.decode_range(ws['!ref']);
            newRange.e.r += 3;
            ws['!ref'] = XLSX.utils.encode_range(newRange);

            const fileName = `Aging_Dashboard_${getCurrentIndianDate().replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showNotification('Excel file exported successfully', 'success');
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Error exporting Excel file. Please try again.', 'error');
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 transition-all duration-300 ${bgColor} text-white`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${type === 'success' ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}"></path>
                </svg>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        calculateStats();
        document.getElementById('currentDate').textContent = getCurrentIndianDate();
        initializeTableNavigation();
        filterRiskData('all'); // Show all by default
    });

    // Recalculate stats on window resize
    window.addEventListener('resize', function() {
        calculateStats();
        clearCellSelection();
    });

    document.addEventListener('click', function(e) {
        const table = document.getElementById('ageingTable');
        if (table && !table.contains(e.target)) clearCellSelection();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            exportToExcel();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
            e.preventDefault();
            const table = document.getElementById('ageingTable');
            if (table && window.innerWidth >= 1024) table.focus();
        }
    });
</script>
</div>

{% endblock %}
