{% extends 'lay/task.html' %}

{% load static %}


{% block table %}
  <div class="flex flex-col md:flex-row justify-between items-center gap-4 p-4 md:px-8 md:py-6  rounded shadow">
  
  <div class="w-full md:w-auto text-center md:text-left">
    <h3 class="text-lg font-[Michroma] text-gray-800">
      LAY PLAN
    </h3>
  </div>

  <div class="w-full md:w-auto text-center">
    <select name="lay_plan" id="tableId_select"
        class="border border-gray-300 rounded-md px-3 py-2 w-full md:w-40 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="1" {% if tableId == 1 %}selected{% endif %}>Table 1</option>
      <option value="2" {% if tableId == 2 %}selected{% endif %}>Table 2</option>
    </select>
  </div>

  <div class="w-full md:w-auto text-center md:text-right">
    <h3 class="text-lg font-[Michroma] text-gray-800" >
      To TABLE - {{ id }}
    </h3>
    
  </div>

</div>
<input type="hidden" id="oldtable" value="{{ id }}">

  
{% endblock %}


{% block content_table %}

<div class="overflow-x-auto w-full mt-3 px-4">
  <div class="flex items-center justify-center mt-5 font-[Inter] text-xs">
      <div class="-rotate-90 mt-4 w-auto h-auto">
        <h1 class="text-[16px] font-bold font-[open sans] px-4 md:w-[100px]">CUT SAMPLE</h1>
      </div>
      <div>
        <p class="text-xl md:text-xl text-[#8AA7B2] text-center ">count - {{ cutsample_count }}</p>
<div class="overflow-x-auto">
  <div class="relative max-h-[300px]">
    
    <table class="table-auto border-collapse w-full">
      <thead class="text-center font-[Inter] font-bold text-xs md:text-sm bg-white">
        <tr>
          <th scope="col" class="sticky top-0 left-0 z-20 bg-white px-2 md:px-4 py-4 md:py-8 w-[80px] md:w-[100px] border border-black">
            PLAN NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            JOB NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[120px] md:w-[150px] border border-black">
            COLOR
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            LOT NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[100px] md:w-[120px] border border-black">
            TOTAL PLY
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            WEIGHT
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[100px] md:w-[120px] border border-black">
            LAY LENGTH
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 border border-black">
            Ready To Move
          </th>
        </tr>
      </thead>

      <tbody class="text-center font-[Inter] text-sm md:text-base overflow-y-auto max-h-[300px] divide-y divide-gray-200">
        {% for data in datas %}
        <tr class="hover:bg-gray-100 transition-colors">
          <td class="sticky left-0 z-10  border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.planno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.jobno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[120px] md:w-[150px]">
            {{ data.clrcomb }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.lotno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[100px] md:w-[120px]">
            {{ data.ply }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.wgt }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[100px] md:w-[120px]">
            {{ data.lay_lenmtr }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2">
            <button>
              <input type="checkbox" class="w-6 h-6 selected-plans" value="{{ data.planno }}|{{ data.jobno }}">
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>




      </div>
    </div>
</div>

<div class="overflow-x-auto w-full mt-3 px-4 mb-4">
  <div class="flex items-center justify-center mt-5 font-[Inter] text-xs">
      <div class="-rotate-90 mt-4 w-auto h-auto">
        <h1 class="text-[16px] font-bold font-[open sans] px-4 md:w-[100px]">Order</h1>
      </div>
      <div>
        <p class="text-xl md:text-xl text-[#8AA7B2] text-center ">count - {{ order_count }}</p>
    <div class="overflow-x-auto">
  <div class="relative max-h-[300px]">
    <table class="table-auto border-collapse w-full">
      <thead class="text-center font-[Inter] font-bold text-xs md:text-sm bg-white">
        <tr>
          <th scope="col" class="sticky top-0 left-0 z-20 bg-white px-2 md:px-4 py-4 md:py-8 w-[80px] md:w-[100px] border border-black">
            PLAN NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            JOB NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[120px] md:w-[150px] border border-black">
            COLOR
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            LOT NO
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[100px] md:w-[120px] border border-black">
            TOTAL PLY
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[80px] md:w-[100px] border border-black">
            WEIGHT
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 w-[100px] md:w-[120px] border border-black">
            LAY LENGTH
          </th>
          <th scope="col" class="sticky top-0 z-10 bg-white px-2 md:px-4 py-2 md:py-4 border border-black">
            Ready To Move 
          </th>
        </tr>
      </thead>

      <tbody class="text-center font-[Inter] text-sm md:text-base overflow-y-auto max-h-[300px] divide-y divide-gray-200">
        {% for data in orders %}
        <tr class="hover:bg-gray-100 transition-colors">
          <td class="sticky left-0 z-10  border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.planno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.jobno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[120px] md:w-[150px]">
            {{ data.clrcomb }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.lotno }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[100px] md:w-[120px]">
            {{ data.ply }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[80px] md:w-[100px]">
            {{ data.wgt }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2 w-[100px] md:w-[120px]">
            {{ data.lay_lenmtr }}
          </td>
          <td class="border border-black px-2 md:px-4 py-2">
            <button>
              <input type="checkbox" class="w-6 h-6 selected-plans" value="{{ data.planno }}|{{ data.jobno }}">
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
      </div>
    </div>
</div>

<div class="flex justify-center mb-8">
   <button id="confirmBtn"
      class="mt-6 px-6 py-2 bg-[#8AA7B2] w-[107px] h-[33px] text-white font-bold text-[13px] 
      rounded shadow-md shadow-[#8AA7B2] shadow-[0px 4px 4px rgba(0, 0, 0, 0.25)] font-[Inter]">
        Confirm
    </button>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tableSelect = document.getElementById("tableId_select");
    const oldtable = document.getElementById("oldtable");

    // Table change logic
    if (tableSelect && oldtable) {
      tableSelect.addEventListener("change", function () {
        const selectedId = this.value;
        const oldId = oldtable.value;

        if (selectedId === oldId) {
          alert("You are already on this table.");
          return;
        }

        window.location.href = `/lay_spreading/overwrite/${oldId}/${selectedId}/`;
      });
    }

    // Confirm move logic
    const confirmBtn = document.getElementById("confirmBtn");
    confirmBtn.addEventListener("click", function () {
      const selected = Array.from(document.querySelectorAll(".selected-plans:checked"))
                            .map(cb => cb.value);

      const fromTable = document.getElementById("oldtable").value;
      const toTable = document.getElementById("tableId_select").value;
      console.log("FROM TABLE:", fromTable);
      console.log("TO TABLE:", toTable);


      if (fromTable === toTable) {
        alert("Source and target tables must be different.");
        return;
      }

      if (selected.length === 0) {
        alert("Please select at least one plan to move.");
        return;
      }

      confirmBtn.disabled = true;
      confirmBtn.innerText = "Moving...";

      fetch("{% url 'process_overwrite' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          old_table: fromTable,
          new_table: toTable,
          plans: selected,
        })
      })
      
      .then(response => {
        confirmBtn.disabled = false;
        confirmBtn.innerText = "Confirm";
        if (response.ok) {
          alert("Plans moved successfully.");
          window.location.reload();
        } else {
          alert("Error moving plans.");
        }
      })
      .catch(err => {
        console.error(err);
        confirmBtn.disabled = false;
        confirmBtn.innerText = "Confirm";
        alert("Unexpected error occurred.");
      });
    });
  });
</script>

{% endblock %}

